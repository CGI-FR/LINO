name: push upsert
testcases:
  - name: push upsert insert
    steps:
      # Clean working directory
      - script: rm -f *
      # Reset source database
      - script: sudo docker compose -p lino stop source && sudo docker compose -p lino rm -f source && sudo docker compose -p lino up -d source
        assertions:
          - result.code ShouldEqual 0
      # Set up data connector
      - script: lino dataconnector add source postgresql://postgres:sakila@source:5432/postgres?sslmode=disable
      # Wait for database available (10 retries)
      - script: count=0; while ! lino dc ping source; do echo wait $count; ((count++)) && ((count>=10)) && break; sleep 1; done
        assertions:
          - result.code ShouldEqual 0
      # Set up config
      - script: lino relation extract source
      - script: lino table extract source --only-tables
      # Create a new store row
      - script: echo '{"store_id":999, "manager_staff_id":1, "address_id":1, "last_update":"2006-02-15T04:57:12Z"}' > new_store.json
      - script: lino push upsert source < new_store.json
        assertions:
          - result.code ShouldEqual 0
          - result.systemerr ShouldBeEmpty
      - script: lino pull source --filter store_id=999
        assertions:
          - result.code ShouldEqual 0
          - result.systemout ShouldContainSubstring "store_id":999

  - name: push upsert update
    steps:
      # Clean working directory
      - script: rm -f *
      # Reset source database
      - script: sudo docker compose -p lino stop source && sudo docker compose -p lino rm -f source && sudo docker compose -p lino up -d source
        assertions:
          - result.code ShouldEqual 0
      # Set up data connector
      - script: lino dataconnector add source postgresql://postgres:sakila@source:5432/postgres?sslmode=disable
      # Wait for database available (10 retries)
      - script: count=0; while ! lino dc ping source; do echo wait $count; ((count++)) && ((count>=10)) && break; sleep 1; done
      # Set up config
      - script: lino relation extract source
      - script: lino table extract source --only-tables
      # Update existing store (id 1)
      - script: echo '{"store_id":1, "manager_staff_id":2, "address_id":1, "last_update":"2006-02-15T04:57:12Z"}' > update_store.json
      - script: lino push upsert source < update_store.json
        assertions:
          - result.code ShouldEqual 0
          - result.systemerr ShouldBeEmpty
      - script: lino pull source --filter store_id=1
        assertions:
          - result.code ShouldEqual 0
          - result.systemout ShouldContainSubstring "manager_staff_id":2
