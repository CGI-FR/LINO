name: data connector add
testcases:
- name: add without command
  steps:
      # Clean working directory
  - type: exec
    script: rm -f *
  - type: exec
    script: lino dataconnector add
    assertions:
      - result.code ShouldEqual 1
      - result.systemerr ShouldContainSubstring Usage
  - type: exec
    script: ls -l
    assertions:
      - result.systemout ShouldContainSubstring "total 0"
- name: add dataconnector
  steps:
      # Clean working directory
  - type: exec
    script: rm -f *
  - type: exec
    script: lino dataconnector add source postgresql://postgres:sakila@localhost:5432/postgres?sslmode=disable
    assertions:
      - result.code ShouldEqual 0
      - result.systemout ShouldContainSubstring success
  - type: exec
    script: ls | wc
    assertions:
      - result.systemout ShouldContainSubstring "1"
  - script: |- 
      cat  > expected.yml <<EOF
      version: v1
      dataconnectors:
        - name: source
          url: postgresql://postgres:sakila@localhost:5432/postgres?sslmode=disable
          readonly: false
      EOF
  - script: diff expected.yml dataconnector.yaml
    assertions:
      - result.code ShouldEqual 0
      - result.systemout ShouldBeEmpty
- name: add dataconnector read only
  steps:
      # Clean working directory
  - type: exec
    script: rm -f *
  - type: exec
    script: lino dataconnector add --read-only source postgresql://postgres:sakila@localhost:5432/postgres?sslmode=disable
    assertions:
      - result.code ShouldEqual 0
      - result.systemout ShouldContainSubstring success
  - type: exec
    script: ls | wc
    assertions:
      - result.systemout ShouldContainSubstring "1"
  - script: |- 
      cat  > expected.yml <<EOF
      version: v1
      dataconnectors:
        - name: source
          url: postgresql://postgres:sakila@localhost:5432/postgres?sslmode=disable
          readonly: true
      EOF
  - script: diff expected.yml dataconnector.yaml
    assertions:
      - result.code ShouldEqual 0
      - result.systemout ShouldBeEmpty


- name: add dataconnector with default schema
  steps:
      # Clean working directory
  - type: exec
    script: rm -f *
  - type: exec
    script: lino dataconnector add --schema public source postgresql://postgres:sakila@source:5432/postgres?sslmode=disable 
    assertions:
      - result.code ShouldEqual 0
      - result.systemout ShouldContainSubstring success
  - script: |- 
      cat  > expected.yml <<EOF
      version: v1
      dataconnectors:
        - name: source
          url: postgresql://postgres:sakila@source:5432/postgres?sslmode=disable
          readonly: false
          schema: public
      EOF
  - script: diff expected.yml dataconnector.yaml
    assertions:
      - result.code ShouldEqual 0
      - result.systemout ShouldBeEmpty