name: data connector credential-helper
testcases:
- name: prepare test
  steps:
    # Clean working directory
    - script: rm -f *
    # Make sure source database is up
    - script: docker-compose up -d source
      assertions:
        - result.code ShouldEqual 0
- name: no credential helper
  steps:
    # Add dataconnector without login / password
    - script: lino dc add bdd 'postgresql://source:5432/postgres?sslmode=disable'
      assertions:
        - result.code ShouldEqual 0
        - result.systemout ShouldContainSubstring successfully added dataconnector
    # First ping should ask for user and password
    - script: echo "postgres\nsakila\n" | lino dc ping bdd
      assertions:
        - result.code ShouldEqual 0
        - result.systemout ShouldContainSubstring warn
        - result.systemout ShouldContainSubstring no credential helper installed
        - result.systemout ShouldContainSubstring enter user
        - result.systemout ShouldContainSubstring enter pass
        - result.systemout ShouldContainSubstring ping success
    # Second ping should also ask for user and password because no credential helper were defined
    - script: echo "postgres\nsakila\n" | lino dc ping bdd
      assertions:
        - result.code ShouldEqual 0
        - result.systemout ShouldContainSubstring warn
        - result.systemout ShouldContainSubstring no credential helper installed
        - result.systemout ShouldContainSubstring enter user
        - result.systemout ShouldContainSubstring enter pass
        - result.systemout ShouldContainSubstring ping success
    # With --no-prompt flag, nothing is asked and the ping fails
    - script: lino --no-prompt dc ping bdd
      assertions:
        - result.code ShouldEqual 1
        - result.systemout ShouldContainSubstring ping failed
- name: with credential helper
  steps:
    # Enable mock credential helper as docker-credential-pass
    - script: cp /usr/local/bin/docker-credential-mock docker-credential-secretservice
    - script: PATH=$PATH:$PWD
    # First ping should ask for user and password
    - script: echo "postgres\nsakila\n" | lino dc ping bdd
      assertions:
        - result.code ShouldEqual 0
        - result.systemout ShouldNotContainSubstring no credential helper installed
        - result.systemout ShouldContainSubstring enter user
        - result.systemout ShouldContainSubstring enter pass
        - result.systemout ShouldContainSubstring ping success
    # Second ping should not because the credential helper stored the credentials
    - script: lino dc ping bdd
      assertions:
        - result.code ShouldEqual 0
        - result.systemout ShouldNotContainSubstring no credential helper installed
        - result.systemout ShouldNotContainSubstring enter user
        - result.systemout ShouldNotContainSubstring enter pass
        - result.systemout ShouldContainSubstring ping success
    # Verify credentials store
    - script: echo 'postgresql://source:5432/postgres?sslmode=disable' | docker-credential-secretservice get
      assertions:
        - result.systemout ShouldEqual '{"ServerURL":"postgresql://source:5432/postgres?sslmode=disable","Username":"postgres","Secret":"sakila"}'
    # Wrong credentials
    - script: "sed -i 's/secret: sakila/secret: wrong/g' credentials.yaml"
    # Ping should ask again for user and password (because the password provided by the store is wrong)
    - script: echo "postgres\nsakila\n" | lino dc ping bdd
      assertions:
        - result.code ShouldEqual 0
        - result.systemout ShouldNotContainSubstring no credential helper installed
        - result.systemout ShouldContainSubstring enter user
        - result.systemout ShouldContainSubstring enter pass
        - result.systemout ShouldContainSubstring ping success
    # Next ping should not (store is updated with correct value)
    - script: lino dc ping bdd
      assertions:
        - result.code ShouldEqual 0
        - result.systemout ShouldNotContainSubstring no credential helper installed
        - result.systemout ShouldNotContainSubstring enter user
        - result.systemout ShouldNotContainSubstring enter pass
        - result.systemout ShouldContainSubstring ping success
    # Verify credentials store
    - script: echo 'postgresql://source:5432/postgres?sslmode=disable' | docker-credential-secretservice get
      assertions:
        - result.systemout ShouldEqual '{"ServerURL":"postgresql://source:5432/postgres?sslmode=disable","Username":"postgres","Secret":"sakila"}'
    # When username is provided by URL
    - script: lino dc add bdd2 'postgresql://postgres@dest:5432/postgres?sslmode=disable'
    # Ping should only ask for password
    - script: echo "sakila\n" | lino dc ping bdd2
      assertions:
        - result.code ShouldEqual 0
        - result.systemout ShouldNotContainSubstring warn
        - result.systemout ShouldNotContainSubstring no credential helper installed
        - result.systemout ShouldNotContainSubstring enter user
        - result.systemout ShouldContainSubstring enter pass
        - result.systemout ShouldContainSubstring ping success
    # When the password is given by URL
    - script: rm -f dataconnector.yaml && lino dc add bdd 'postgresql://postgres:sakila@source:5432/postgres?sslmode=disable'
      assertions:
        - result.code ShouldEqual 0
        - result.systemout ShouldContainSubstring warn
        - result.systemout ShouldContainSubstring password should not be included in URI
        - result.systemout ShouldContainSubstring successfully added dataconnector
    # Then it should be cleared from URL
    - script: |- 
        cat  > expected.yml <<EOF
        version: v1
        dataconnectors:
          - name: source
            url: postgresql://postgres@localhost:5432/postgres?sslmode=disable
            readonly: false
        EOF
    - script: diff expected.yml dataconnector.yaml
      assertions:
        - result.code ShouldEqual 0
        - result.systemout ShouldBeEmpty
