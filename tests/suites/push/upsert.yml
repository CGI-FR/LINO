name: push upsert
testcases:
  - name: push upsert setup
    steps:
      # Clean working directory
      - script: rm -f *
      # Reset source database
      - script: sudo docker compose -p lino stop source && sudo docker compose -p lino rm -f source && sudo docker compose -p lino up -d source
        assertions:
          - result.code ShouldEqual 0
      # Set up data connector
      - script: lino dataconnector add source postgresql://postgres:sakila@source:5432/postgres?sslmode=disable
      # Wait for database available (10 retries)
      - script: count=0; while ! lino dc ping source; do echo wait $count; ((count++)) && ((count>=10)) && break; sleep 1; done
        assertions:
          - result.code ShouldEqual 0
      # Set up config
      - script: lino relation extract source
      - script: lino table extract source --only-tables
      - script: lino id create country
      - script: sed -i "s/true/false/g" ingress-descriptor.yaml

  - name: push upsert insert
    steps:
      # Create a new store row
      - script: echo '{"country_id":999, "country":"goland" , "last_update":"2006-02-15T04:57:12Z"}' > new_country.jsonl
      - script: lino push upsert source < new_country.jsonl
        assertions:
          - result.code ShouldEqual 0
          - result.systemerr ShouldBeEmpty
      - script: lino pull source --filter country_id=999
        assertions:
          - result.code ShouldEqual 0
          - result.systemout ShouldContainSubstring "country_id":999
          - result.systemout ShouldContainSubstring "country":"goland"

  - name: push upsert update
    steps:
      # Update existing store (id 1)
      - script: echo '{"country_id":1, "country":"goland" , "last_update":"2006-02-15T04:57:12Z"}' > update_country.jsonl

      - script: lino push upsert source < update_country.jsonl
        assertions:
          - result.code ShouldEqual 0
          - result.systemerr ShouldBeEmpty
      - script: lino pull source --filter country_id=1
        assertions:
          - result.code ShouldEqual 0
          - result.systemout ShouldContainSubstring "country":"goland"
